<div class="home-container">
  <!-- HEADER -->
  <div class="header">
    <!-- Logo clickeable para ver bater√≠a -->
    <img 
      src="/logo-alertavision.png" 
      class="logo clickable" 
      alt="AlertaVisi√≥n" 
      (click)="onLogoClick()"
      title="Ver estado de la bater√≠a"
    />

    <div class="header-actions">
      <div class="profile-pill" (click)="toggleProfile()">
        <div class="avatar-mini">{{ userName.charAt(0) | uppercase }}</div>
        <div class="profile-text">
          <span class="lbl-user">{{ userName.split(' ')[0] }}</span>
          <span class="lbl-edit">Editar</span>
        </div>
      </div>

      <button class="logout-btn" (click)="logout()">
        <img
          src="https://cdn-icons-png.flaticon.com/512/1828/1828479.png"
          alt="Salir"
        />
      </button>
    </div>
  </div>

  <!-- SALUDO -->
  <h1 class="greeting">
    ¬°Hola {{ userName }}! <br />
    vamos a conducir juntos
  </h1>

  <!-- TARJETA DETECTANDO FATIGAS -->
  <div class="status-card glow-border">
    <h2>Detectando fatigas</h2>
    <p class="subtitle">Mant√©n la concentraci√≥n</p>

    <div class="progress-bar-container">
      <div class="progress-bar-fill" [style.width.%]="fatigaLevel"></div>
      <span class="progress-label">{{ fatigaLevel }}%</span>
    </div>

    <button class="action-btn" (click)="onStartMonitoring()">
      Iniciar monitoreo
    </button>
    <p class="subtitle-small">Conecta tus lentes para iniciar</p>
  </div>

  <!-- TARJETA ESTADO DE LOS LENTES -->
  <div class="status-card">
    <h2 *ngIf="!lentesConectados">No se detectan los lentes</h2>
    <h2 *ngIf="lentesConectados">‚úÖ Lentes conectados</h2>

    <!-- Mostrar bater√≠a si est√° conectado -->
    <div class="battery-indicator" *ngIf="lentesConectados">
      <span class="battery-icon">üîã</span>
      <span class="battery-level" [style.color]="getBatteryColor()">
        {{ batteryLevel }}%
      </span>
    </div>

    <p class="subtitle" *ngIf="!lentesConectados">
      Enciende tus lentes y ac√©rcalos para vincular.
    </p>
    <p class="subtitle" *ngIf="lentesConectados">
      Tus lentes est√°n vinculados a este usuario. Puedes iniciar el monitoreo.
    </p>

    <div class="button-group">
      <button
        class="action-btn secondary"
        (click)="onRetry()"
        [disabled]="conectandoLentes"
      >
        {{ conectandoLentes ? 'Conectando...' : 'Reintentar' }}
      </button>

      <button
        class="action-btn primary"
        (click)="onConnectLenses()"
        [disabled]="conectandoLentes"
      >
        {{
          conectandoLentes
            ? 'Conectando...'
            : (lentesConectados ? 'Reconectar' : 'Conectar')
        }}
      </button>
    </div>

    <p class="error-text" *ngIf="errorConexionLentes">
      {{ errorConexionLentes }}
    </p>
  </div>
</div>

<!-- NAV INFERIOR -->
<nav class="bottom-nav">
  <div class="nav-btn active" (click)="goTo('home')">
    <img src="/fluent-color--home-32.svg" alt="Inicio" class="nav-icon" /><span
      >Inicio</span
    >
  </div>
  <div class="nav-btn" (click)="goTo('history')">
    <img
      src="/icon-park--history-query.svg"
      alt="Alertas"
      class="nav-icon"
    /><span>Alertas</span>
  </div>
  <div class="nav-btn" (click)="goTo('reports')">
    <img
      src="/iconoir--reports-solid.svg"
      alt="Reportes"
      class="nav-icon"
    /><span>Reportes</span>
  </div>
</nav>

<!-- MODAL BATER√çA -->
<div class="battery-backdrop" *ngIf="showBatteryModal" (click)="closeBatteryModal()"></div>

<div class="battery-modal" *ngIf="showBatteryModal">
  <div class="battery-modal-header">
    <h3>üîã Estado de los Lentes</h3>
    <button class="close-btn" (click)="closeBatteryModal()">‚úï</button>
  </div>

  <div class="battery-modal-body">
    <!-- Loading -->
    <div *ngIf="batteryLoading" class="battery-loading">
      <div class="spinner"></div>
      <p>Obteniendo estado...</p>
    </div>

    <!-- Error -->
    <div *ngIf="!batteryLoading && batteryError" class="battery-error">
      <span>‚ùå</span>
      <p>{{ batteryError }}</p>
    </div>

    <!-- Datos -->
    <div *ngIf="!batteryLoading && !batteryError" class="battery-content">
      <div class="battery-big" [style.color]="getBatteryColor()">
        <span class="battery-icon-big">{{ getBatteryIcon() }}</span>
        <span class="battery-value">{{ batteryLevel }}%</span>
      </div>

      <div class="battery-status">
        <div class="status-row">
          <span class="label">Estado:</span>
          <span class="value" [class.connected]="lentesConectados" [class.disconnected]="!lentesConectados">
            {{ lentesConectados ? '‚úÖ Conectados' : '‚ùå Desconectados' }}
          </span>
        </div>
        <div class="status-row" *ngIf="lastBatteryUpdate">
          <span class="label">√öltima actualizaci√≥n:</span>
          <span class="value">{{ lastBatteryUpdate }}</span>
        </div>
      </div>

      <div class="battery-bar-container">
        <div class="battery-bar-fill" 
             [style.width.%]="batteryLevel"
             [style.background]="getBatteryColor()">
        </div>
      </div>

      <p class="battery-tip" *ngIf="batteryLevel <= 20">
        ‚ö†Ô∏è Bater√≠a baja. Considera cargar tus lentes.
      </p>
    </div>
  </div>

  <div class="battery-modal-footer">
    <button class="btn-refresh" (click)="fetchBatteryLevel()">
      üîÑ Actualizar
    </button>
    <button class="btn-close" (click)="closeBatteryModal()">
      Cerrar
    </button>
  </div>
</div>

<!-- MODAL PERFIL -->
<div class="profile-backdrop" *ngIf="showProfileModal" (click)="toggleProfile()"></div>

<div class="profile-modal" *ngIf="showProfileModal">
  <div class="profile-header">
    <div class="avatar-large">{{ userName.charAt(0) | uppercase }}</div>
    <div class="header-info">
      <h3>{{ userName }}</h3>
      <p>{{ userEmail }}</p>
    </div>
    <button class="close-btn" (click)="toggleProfile()">‚úï</button>
  </div>

  <div class="profile-body">
    <div class="form-group">
      <label>Nombre de Usuario</label>
      <input type="text" [(ngModel)]="editData.nombre" placeholder="Tu nombre" />
    </div>

    <div class="form-group">
      <label>Tel√©fono</label>
      <input
        type="text"
        [(ngModel)]="editData.telefono"
        placeholder="Ej: 099..."
      />
    </div>

    <div class="form-group">
      <label>Correo de Recuperaci√≥n</label>
      <input
        type="email"
        [(ngModel)]="editData.email_recuperacion"
        placeholder="respaldo@gmail.com"
      />
    </div>
  </div>

  <div class="profile-footer">
    <button class="btn-cancel" (click)="toggleProfile()">Cancelar</button>
    <button class="btn-save" (click)="saveProfile()">Guardar Cambios</button>
  </div>
</div>
