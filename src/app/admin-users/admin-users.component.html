<div class="dashboard-container">
  
  <div class="main-header">
    <h2>Gesti√≥n de Usuarios Avanzada - AlertaVisi√≥n</h2>
    <button class="btn-primary" (click)="openModal(undefined, 'info')">+ Nuevo Usuario</button>
  </div>

  <div class="table-card">
    <table class="styled-table" *ngIf="!isLoading">
      <thead>
        <tr>
          <th>ID</th><th>Usuario</th><th>Email</th><th>Rol</th><th>Tel√©fono</th><th>Estado</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of usuarios">
          <td>{{ user.id }}</td>
          <td>
            <div class="user-cell">
              <div class="avatar">{{ getInitial(user.nombre) }}</div>
              <strong>{{ user.nombre }}</strong>
            </div>
          </td>
          <td>{{ user.email }}</td>
          <td><span class="badge role">{{ user.rol | uppercase }}</span></td>
          <td>{{ user.telefono || '--' }}</td>
          <td><span class="badge active">ACTIVO</span></td>
          <td>
            <div class="actions">
              <button class="btn-icon" (click)="openModal(user, 'info')">‚úèÔ∏è</button>
              <button class="btn-icon" (click)="eliminarUsuario(user.id)">üóëÔ∏è</button>
              <button class="btn-icon view" (click)="openModal(user, 'historial')">üëÅÔ∏è</button>
              <button class="btn-icon chart" (click)="openModal(user, 'reportes')">üìä</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

</div>

<div class="modal-overlay" *ngIf="showModal">
  <div class="modal-card">
    
    <div class="modal-header">
      <h3>Detalles: {{ currentUser.nombre }}</h3>
      <button class="close-x" (click)="closeModal()">‚úï</button>
    </div>

    <div class="modal-tabs">
      <button [class.active]="currentTab === 'info'" (click)="cambiarPestana('info')">Informaci√≥n</button>
      <button [class.active]="currentTab === 'historial'" (click)="cambiarPestana('historial')">Historial de Alertas</button>
      <button [class.active]="currentTab === 'reportes'" (click)="cambiarPestana('reportes')">Informes / Gr√°ficas</button>
    </div>

    <div class="modal-body">
      
      <div *ngIf="currentTab === 'info'" class="tab-content fade-in">
        <div class="form-grid">
          <div class="input-group">
            <label>Nombre</label><input [(ngModel)]="currentUser.nombre">
          </div>
          <div class="input-group">
            <label>Email</label><input [(ngModel)]="currentUser.email">
          </div>
          <div class="input-group">
            <label>Tel√©fono</label><input [(ngModel)]="currentUser.telefono">
          </div>
          <div class="input-group">
            <label>Rol</label>
            <select [(ngModel)]="currentUser.rol">
              <option value="usuario">Usuario</option>
              <option value="admin">Administrador</option>
            </select>
          </div>
        </div>
        <div class="footer-actions">
           <button class="btn-save" (click)="guardarUsuario()">Guardar Cambios</button>
        </div>
      </div>

      <div *ngIf="currentTab === 'historial'" class="tab-content fade-in">
        <div class="history-list">
          <div class="alert-item" *ngFor="let item of alertas">
            <div class="alert-bar"></div>
            <div class="alert-info">
              <span class="alert-msg">{{ item.mensaje }}</span>
              <span class="alert-date">
                {{ formatDateTime(item.created_at).fecha }} - {{ formatDateTime(item.created_at).hora }}
              </span>
            </div>
          </div>
          <div *ngIf="alertas.length === 0" class="empty-msg">No hay alertas registradas.</div>
        </div>
      </div>

      <div *ngIf="currentTab === 'reportes'" class="tab-content fade-in">
        <div class="reports-layout">
          <div class="chart-container">
            <h4>Nivel de Somnolencia (√öltimos 7 d√≠as)</h4>
            <div class="canvas-wrapper">
              <canvas baseChart [data]="barData" [options]="barOptions" [type]="'bar'"></canvas>
            </div>
          </div>
          <div class="kpi-container">
            <div class="kpi-box"><span>Promedio</span><strong>{{ promedioDia }}</strong></div>
            <div class="kpi-box"><span>M√°ximo</span><strong>{{ mejorDia }}</strong></div>
            <div class="kpi-box"><span>M√≠nimo</span><strong>{{ peorDia }}</strong></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>