<div class="reports-container">
  <h1 class="title">Reportes</h1>

  <div class="tabs">
    <button class="tab" [class.active]="activeTab==='diario'" (click)="setTab('diario')">Diario</button>
    <button class="tab" [class.active]="activeTab==='semanal'" (click)="setTab('semanal')">Semanal</button>
    <button class="tab" [class.active]="activeTab==='mensual'" (click)="setTab('mensual')">Mensual</button>
  </div>
  <div *ngIf="errorMsg" class="error">{{ errorMsg }}</div>

  <!-- GRÁFICAS -->
  <div class="chart-card" *ngIf="activeTab==='diario'">
    <canvas baseChart [type]="'bar'" [data]="barData" [options]="barOptions"></canvas>
    <div class="empty" *ngIf="!loading && (!barData.datasets[0].data || !barData.datasets[0].data.length)">Sin datos en este rango.</div>
  </div>
  <div class="chart-card" *ngIf="activeTab==='semanal'">
    <canvas baseChart [type]="'line'" [data]="lineData" [options]="lineOptions"></canvas>
    <div class="empty" *ngIf="!loading && (!lineData.datasets[0].data || !lineData.datasets[0].data.length)">Sin datos en este rango.</div>
  </div>
  <div class="chart-card" *ngIf="activeTab==='mensual'">
    <canvas baseChart [type]="'doughnut'" [data]="donutData" [options]="donutOptions"></canvas>
    <div class="empty" *ngIf="!loading && (!donutData.datasets[0].data || !donutData.datasets[0].data.length)">Sin datos en este rango.</div>
  </div>

  <div class="kpis">
    <div class="kpi">
      <div class="label">Somnolencia promedio</div>
      <div class="value">{{ promedioDia | number:'1.0-1' }}</div>
    </div>
    <div class="kpi">
      <div class="label">Día mayor</div>
      <div class="value">{{ mejorDia | number:'1.0-1' }}</div>
    </div>
    <div class="kpi">
      <div class="label">Día menor</div>
      <div class="value">{{ peorDia | number:'1.0-1' }}</div>
    </div>
  </div>

  <!-- SECCIÓN DE EXPORTACIÓN -->
  <div class="export">
    
    <!-- 1. Botón Grande: "Enviar a mi correo" -->
    <button class="btn-quick" (click)="exportarCorreoUsuario()" [disabled]="sending">
      <ng-container *ngIf="!sending; else sendingTemplate">
        <!-- Texto principal solicitado -->
        <span class="btn-main-text">Enviar a mi correo</span>
        <!-- Correo pequeño para confirmación visual -->
        <span class="btn-sub-text">({{ userEmail || '...' }})</span>
      </ng-container>
      <ng-template #sendingTemplate>Enviando...</ng-template>
    </button>

    <!-- 2. Separador -->
    <div class="separator-text">o enviar a otro correo:</div>

    <!-- 3. Opción Manual -->
    <div class="manual-group">
      <input type="email" placeholder="otro@correo.com" [(ngModel)]="email">
      <button (click)="exportarCorreoManual()" [disabled]="sending">Enviar</button>
    </div>

    <div class="export-msg" *ngIf="exportMsg">{{ exportMsg }}</div>
  </div>

  <div class="settings-section">
    <h2 class="settings-title">Ajustes</h2>
    <div class="setting-item">
      <span>Modo Oscuro</span>
      <label class="toggle-switch">
        <input type="checkbox" [checked]="isDarkMode" (change)="toggleDarkMode()">
        <span class="slider"></span>
      </label>
    </div>
    <div class="setting-item">
      <span>Activar Notificaciones</span>
      <label class="toggle-switch">
        <input type="checkbox" [checked]="notificationsEnabled" (change)="toggleNotifications()">
        <span class="slider"></span>
      </label>
    </div>
    <div class="setting-item contact">
      <span>Contacta con nosotros</span>
      <a href="mailto:carojas@sudamericano.edu.ec" class="contact-link">carojas&#64;sudamericano.edu.ec</a>
    </div>
  </div>
  <div *ngIf="loading" class="loading">Cargando…</div>
</div>

<nav class="bottom-nav">
  <div class="nav-btn" (click)="goTo('home')">
    <img src="/fluent-color--home-32.svg" alt="Inicio" class="nav-icon" /><span>Inicio</span>
  </div>
  <div class="nav-btn" (click)="goTo('history')">
    <img src="/icon-park--history-query.svg" alt="Alertas" class="nav-icon" /><span>Alertas</span>
  </div>
  <div class="nav-btn active" (click)="goTo('reports')">
    <img src="/iconoir--reports-solid.svg" alt="Reportes" class="nav-icon" /><span>Reportes</span>
  </div>
</nav>